name: Java CI/CD with Expressions Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  JAVA_VERSION: '11'
  MAVEN_OPTS: '--no-transfer-progress'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Build and test with Maven
      run: mvn ${{ env.MAVEN_OPTS }} clean test
      env:
        GITHUB_ACTIONS: true

    - name: Show test context
      run: |
        echo "Test job completed successfully!"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Event: ${{ github.event_name }}"
        echo "Workflow: ${{ github.workflow }}"

  build:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Build with Maven
      run: mvn ${{ env.MAVEN_OPTS }} clean compile

    - name: Show build context
      run: |
        echo "Build environment: ${{ inputs.environment || 'auto' }}"
        echo "Actor: ${{ github.actor }}"
        echo "SHA: ${{ github.sha }}"
        echo "Is main branch: ${{ github.ref == 'refs/heads/main' }}"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && (inputs.environment == 'staging' || inputs.environment == 'production') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show deployment context
      run: |
        echo "=== Deployment Context ==="
        echo "Target environment: ${{ inputs.environment }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Repository: ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Event: ${{ github.event_name }}"
        echo "Runner OS: ${{ runner.os }}"
        echo "Workspace: ${{ github.workspace }}"
        
        echo "=== Conditional Expressions ==="
        echo "Is production: ${{ inputs.environment == 'production' }}"
        echo "Is staging: ${{ inputs.environment == 'staging' }}"
        echo "Has needs context: ${{ needs.build.result == 'success' }}"

    - name: Simulate deployment
      run: |
        echo "Simulating deployment to ${{ inputs.environment }}"
        echo "Application: ${{ github.repository }}"
        echo "Version: 1.0.0-${{ github.sha }}"
